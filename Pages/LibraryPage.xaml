<Page
    x:Class="AmongUsModManager.Pages.LibraryPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:models="using:AmongUsModManager.Models"
    xmlns:local="using:AmongUsModManager.Pages"
    mc:Ignorable="d">

    <Page.Resources>
        <local:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <local:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
    </Page.Resources>

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <InfoBar x:Name="VersionIssueBar"
                 Grid.Row="0"
                 Title="バージョンの不一致"
                 Message="GitHubのリリースタグとの連携の再設定を行ってください。"
                 Severity="Warning"
                 IsOpen="False"
                 Margin="0,0,0,10">
            <InfoBar.ActionButton>
                <Button Content="詳細を確認して解決" Click="ResolveVersionIssues_Click"/>
            </InfoBar.ActionButton>
        </InfoBar>

        <RelativePanel Grid.Row="1" Margin="0,0,0,24">
            <StackPanel x:Name="HeaderPanel" Spacing="5">
                <TextBlock Text="Modライブラリ" FontSize="28" FontWeight="SemiBold"/>
                <TextBlock Text="ドラッグで並び替えが可能です" Foreground="Gray" FontSize="12"/>
            </StackPanel>

            <StackPanel Orientation="Horizontal" Spacing="10" RelativePanel.AlignRightWithPanel="True" RelativePanel.AlignVerticalCenterWithPanel="True">
                <Button Click="GridModeBtn_Click" ToolTipService.ToolTip="グリッド表示">
                    <SymbolIcon Symbol="ViewAll"/>
                </Button>
                <Button Click="ListModeBtn_Click" ToolTipService.ToolTip="リスト表示">
                    <SymbolIcon Symbol="List"/>
                </Button>
            </StackPanel>
        </RelativePanel>

        <GridView Grid.Row="2" x:Name="LibraryGridView" 
                  CanReorderItems="True" AllowDrop="True" DragItemsCompleted="LibraryGridView_DragItemsCompleted"
                  SelectionMode="None">
            <GridView.ItemTemplate>
                <DataTemplate x:DataType="models:VanillaPathInfo">
                    <RelativePanel x:Name="ItemPanel" MinWidth="310" Height="170" Margin="0,0,12,12" Padding="16"
                                   Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}" CornerRadius="8">
                        <TextBlock x:Name="NameTxt" Text="{x:Bind Name, Mode=OneWay}" FontSize="18" FontWeight="Bold"/>
                        <TextBlock x:Name="VerTxt" Text="{x:Bind CurrentVersion, Mode=OneWay}" RelativePanel.Below="NameTxt" Foreground="Gray" FontSize="11"/>

                        <StackPanel Orientation="Horizontal" RelativePanel.Below="VerTxt" Margin="0,5,0,0" Spacing="5">
                            <Border Background="SteelBlue" CornerRadius="4" Padding="4,1" 
                                    Visibility="{x:Bind GitHubRepo, Converter={StaticResource StringToVisibilityConverter}, Mode=OneWay, FallbackValue=Collapsed}">
                                <TextBlock Text="連携済み" FontSize="9" Foreground="White"/>
                            </Border>
                            <Border Background="SeaGreen" CornerRadius="4" Padding="4,1" 
                                    Visibility="{x:Bind IsAutoUpdateEnabled, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay, FallbackValue=Collapsed}">
                                <TextBlock Text="自動更新:ON" FontSize="9" Foreground="White"/>
                            </Border>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Spacing="8" RelativePanel.AlignBottomWithPanel="True" RelativePanel.AlignRightWithPanel="True">
                            <Button Content="フォルダ" Click="OpenFolder_Click" Tag="{x:Bind Path}"/>
                            <Button Content="起動" Style="{StaticResource AccentButtonStyle}" Click="LaunchMod_Click" Tag="{x:Bind Path}"/>
                            <Button Content="...">
                                <Button.Flyout>
                                    <MenuFlyout>
                                        <MenuFlyoutItem Text="名前変更" Icon="Edit" Click="RenameMod_Click" Tag="{x:Bind}"/>
                                        <MenuFlyoutItem Text="GitHub連携" Icon="Link" Click="LinkGitHub_Click" Tag="{x:Bind}"/>
                                        <MenuFlyoutItem Text="今すぐアップデート" Icon="Refresh" Click="UpdateMod_Click" Tag="{x:Bind}"/>
                                        <ToggleMenuFlyoutItem Text="自動アップデート" IsChecked="{x:Bind IsAutoUpdateEnabled, Mode=TwoWay}"/>
                                        <MenuFlyoutSeparator/>
                                        <MenuFlyoutItem Text="削除" Foreground="Red" Icon="Delete" Click="DeleteMod_Click" Tag="{x:Bind}"/>
                                    </MenuFlyout>
                                </Button.Flyout>
                            </Button>
                        </StackPanel>
                    </RelativePanel>
                </DataTemplate>
            </GridView.ItemTemplate>
        </GridView>

        <ContentDialog x:Name="UpdateProgressDialog" Title="アップデート中" CloseButtonText="閉じる">
            <StackPanel Spacing="15" Width="300">
                <TextBlock x:Name="UpdateStatusText" Text="準備中..."/>
                <ProgressBar x:Name="UpdateProgressBar" Minimum="0" Maximum="100" IsIndeterminate="True"/>
            </StackPanel>
        </ContentDialog>
    </Grid>
</Page>
